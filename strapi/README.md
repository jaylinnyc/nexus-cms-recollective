# Strapi CMS for Recollective

This directory contains the Strapi instance used as the content management system (CMS) for the Recollective project. Strapi serves as the backend for managing content, which is consumed by the frontend application. It integrates with PostgreSQL for data storage, MinIO for media uploads, and supports custom schemas for content types.

The Strapi setup is part of a larger monorepo (`nexus-cms-recollective`), but this README focuses on Strapi-specific development, configuration, building, and usage.

## Project Structure

- **config/**: Strapi configuration files (e.g., database.js, plugins.js for email/SMTP if needed).
- **database/**: Database migration and schema files.
- **dist/**: Built distribution files (generated during production builds).
- **public/**: Public assets, including `uploads/` for media files (mounted as a volume in production).
- **src/**: Custom source code.
  - `admin/`: Admin panel customizations.
  - `api/`: API controllers, services, and models for content types.
  - `extensions/`: Plugin extensions (e.g., for users-permissions).
  - `plugins/`: Custom plugins.
- **Dockerfile**: For development Docker builds.
- **Dockerfile.prod**: Optimized for production builds.
- **docker-compose.yml**: Local Compose file for running Strapi with dependencies (e.g., DB) in dev.
- **favicon.png**: Default favicon.
- **package.json**: Dependencies (Strapi core, plugins like @strapi/plugin-users-permissions, @strapi/plugin-i18n).
- **tsconfig.json**: TypeScript configuration (if using TS).
- **yarn.lock** / **package-lock.json**: Dependency locks.
- Other files: Generated by Strapi (e.g., .cache/, .tmp/ â€“ gitignored).

## Development Setup

### Prerequisites
- Node.js (v18+ recommended, as per Strapi requirements).
- Yarn (preferred) or npm.
- Docker for containerized dev (optional but recommended).
- PostgreSQL (local or via Docker) for the database.

### Running Locally
1. Install dependencies:
   ```
   yarn install
   ```

2. Copy and configure env file (from monorepo root or create .env):
   ```
   cp ../envsample.strapi .env
   # Edit with dev values: DATABASE_HOST=localhost, DATABASE_PORT=5432, DATABASE_NAME=strapi, etc.
   # Also set JWT_SECRET, ADMIN_JWT_SECRET, APP_KEYS, API_TOKEN_SALT.
   ```

3. Start PostgreSQL (if not using Docker):
   - Use a local Postgres instance or spin up via Docker: `docker run -d -p 5432:5432 --name strapi-db -e POSTGRES_PASSWORD=yourpass postgres`.

4. Run Strapi in development mode:
   ```
   yarn develop
   ```
   - Access admin at http://localhost:1337/admin.
   - If first run, create an admin user.

Alternatively, use the local `docker-compose.yml`:
```
docker compose up -d
```
- This starts Strapi with a linked DB.

### Configuring and Building Schema
- Use the admin UI (http://localhost:1337/admin) to create content types (e.g., Pages, Articles, Media).
  - Define fields, relations, and permissions.
  - Schemas are auto-generated in `src/api/` (e.g., `src/api/post/content-types/post/schema.json`).
- For custom logic:
  - Add controllers/services in `src/api/[content-type]/`.
  - Customize lifecycle hooks (e.g., beforeCreate) for integrations like image processing.
- Install plugins via UI or CLI:
  ```
  yarn strapi install graphql
  ```
- Test API endpoints: http://localhost:1337/api/[content-type] (use API tokens for auth).
- Commit schema changes to git for version control.

## Building Docker Images

For deployment, build production-optimized images.

1. Build the prod image:
   ```
   docker build -f Dockerfile.prod -t docker.goodgermy.com/nexus/recollective/strapi:latest .
   ```

2. Push to private registry:
   ```
   docker push docker.goodgermy.com/nexus/recollective/strapi:latest
   ```

- View tags: https://docker-ui.goodgermy.com/#!/taglist/nexus/recollective/strapi
- Note: The build process installs dependencies, builds the admin panel, and sets `NODE_ENV=production`.

## Deployment to Production

In the monorepo, Strapi is deployed via `docker-compose.prod.yml` (root level).

- Service: `rc-strapi`
- Image: Pulled from `docker.goodgermy.com/nexus/recollective/strapi:latest`
- Env: From `.env.production.strapi` (includes DB connection to `rc-strapi-db`, JWT secrets).
- Volumes: Uploads mounted to host for persistence (`${MY_DOCKER_DATA_PATH}/nexus/recollective/rc-strapi/public/uploads`).
- Network: `traefik-net` for routing.
- Exposed at: https://cms.recollectivect.com (via Traefik).
- Depends on: `rc-strapi-db` (Postgres).

To deploy:
1. Ensure env files are set in the root.
2. Pull image and start:
   ```
   cd ..  # To monorepo root
   docker compose -f docker-compose.prod.yml up -d rc-strapi rc-strapi-db
   ```

- Admin access: https://cms.recollectivect.com/admin
- API: https://cms.recollectivect.com/api
- DB management: Via `rc-strapi-adminer` at https://adminer.recollectivect.com

## Using Strapi in the Frontend App

The frontend (in ../frontend) consumes Strapi APIs for content.

- Configure frontend env (e.g., `VITE_STRAPI_URL=https://cms.recollectivect.com`).
- Auth: Use API tokens (generate in Strapi UI: Settings > API Tokens) for read access.
- Example fetch in frontend (e.g., in `src/api.ts`):
  ```ts
  import axios from 'axios';

  const strapi = axios.create({
    baseURL: import.meta.env.VITE_STRAPI_URL,
    headers: { Authorization: `Bearer ${import.meta.env.VITE_STRAPI_TOKEN}` },
  });

  export async function getContent(type: string) {
    const { data } = await strapi.get(`/api/${type}?populate=*`);
    return data.data;
  }
  ```
- Populate relations: Use `?populate=*` or specific fields for media/relations.
- Media: URLs point to MinIO (e.g., https://media.recollectivect.com), processed by the image resizer.

For protected content, integrate with users-permissions plugin and JWT auth.

## Troubleshooting
- Forgot password: Run `yarn strapi admin:reset-user-password --email=your@email.com --password=NewPass` (or via Docker exec).
- Logs: `docker compose logs strapi` (in dev) or `docker logs rc-strapi` (prod).
- DB issues: Use Adminer or connect directly to Postgres.
- Refer to Strapi docs: https://docs.strapi.io
- For monorepo integration issues, see ../README.md.